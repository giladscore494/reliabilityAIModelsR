<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>×× ×•×¢ ×”××œ×¦×•×ª ×¨×›×‘ â€“ ×™×“×¢ ×¨×›×‘ AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CDN (×‘×“×•××” ×œ×©××¨ ×”××ª×¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <!-- Top bar -->
    <header class="border-b border-slate-200 bg-white">
        <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center rounded-full bg-slate-900 text-white w-8 h-8 text-sm font-bold">
                    Y
                </span>
                <div>
                    <div class="text-sm font-semibold text-slate-900">×™×“×¢ ×¨×›×‘ AI</div>
                    <div class="text-xs text-slate-500">×× ×•×¢ ×”××œ×¦×•×ª ×¨×›×‘ ×—×›×</div>
                </div>
            </div>
            <nav class="flex items-center gap-3 text-xs sm:text-sm">
                <a href="{{ url_for('index') }}" class="text-slate-500 hover:text-slate-900">×××™× ×•×ª ×¨×›×‘</a>
                <span class="text-slate-300">|</span>
                <span class="font-semibold text-slate-900">×× ×•×¢ ×”××œ×¦×•×ª</span>
                {% if user.is_authenticated %}
                    <span class="text-slate-300">|</span>
                    <a href="{{ url_for('dashboard') }}" class="text-slate-500 hover:text-slate-900">×”×“×©×‘×•×¨×“ ×©×œ×™</a>
                    <span class="text-slate-300">|</span>
                    <span class="text-slate-500 text-xs sm:text-sm truncate max-w-[120px]">
                        {{ user.email }}
                    </span>
                {% endif %}
            </nav>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
        <!-- ×›×•×ª×¨×ª -->
        <section class="space-y-2">
            <h1 class="text-xl sm:text-2xl font-bold text-slate-900">
                ×× ×•×¢ ×”××œ×¦×•×ª ×¨×›×‘ â€“ ×’×¨×¡×ª × ×™×¡×•×™
            </h1>
            <p class="text-sm text-slate-600">
                ×× ×•×¢ ×”××œ×¦×•×ª ××•×˜×•××˜×™ ×©×× ×ª×— ×¤×¨×•×¤×™×œ × ×”×’ ××œ× ×•××¦×™×¢ ×¨×©×™××ª ×¨×›×‘×™× ××ª××™××” ×œ×©×•×§ ×”×™×©×¨××œ×™, ×‘×¢×–×¨×ª Gemini 3 + ×—×™×¤×•×© ×¨×©×ª.
            </p>
        </section>

        {% if not is_owner %}
            <!-- ××¦×‘: ××©×ª××© ×¨×’×™×œ â€“ ×¢×“×™×™×Ÿ ×œ× ×¤×ª×•×— -->
            <section class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                <p class="text-sm text-slate-700">
                    ×”××•×“×•×œ ×”×–×” × ××¦× ×›×¨×’×¢ ×‘×’×¨×¡×ª ×‘×“×™×§×” ×¤× ×™××™×ª, ×•× ×’×™×© ×¨×§ ×œ×‘×¢×œ ×”××ª×¨.
                </p>
                <p class="mt-2 text-xs text-slate-500">
                    ×‘×©×œ×‘ ×”×”×©×§×” ×”×•× ×™××¤×©×¨ ×œ×›×œ ××©×ª××© ×œ×”×–×™×Ÿ ×¤×¨×•×¤×™×œ ×©×™××•×©, ×ª×§×¦×™×‘ ×•×”×¢×“×¤×•×ª â€“ ×•×œ×§×‘×œ ×¨×©×™××ª ×¨×›×‘×™× ××•××œ×¦×™×,
                    ×¢× ×¢×œ×•×ª ×©× ×ª×™×ª ××©×•×¢×¨×ª, ×××™× ×•×ª ×•× ×ª×•× ×™× × ×•×¡×¤×™×.
                </p>
            </section>
        {% else %}
            <!-- ××¦×‘: ×‘×¢×œ ×”××ª×¨ â€“ ×˜×•×¤×¡ ××œ× + ×ª×•×¦××•×ª -->
            <section class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm space-y-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">×˜×•×¤×¡ ×”×’×“×¨×ª ×¤×¨×•×¤×™×œ × ×”×’</h2>
                        <p class="text-xs text-slate-500">
                            ×”× ×ª×•× ×™× × ×©×œ×—×™× ×œÖ¾<span class="font-semibold">/recommendations/submit</span> ×•×× ×•×ª×—×™× ×¢×´×™ Gemini 3 + Google Search.
                        </p>
                    </div>
                    <button
                        id="advisor-submit-btn"
                        class="inline-flex items-center justify-center rounded-xl bg-slate-900 text-white text-sm px-4 py-2 hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed">
                        ğŸš— ×§×‘×œ ×”××œ×¦×•×ª
                    </button>
                </div>

                <!-- ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ -->
                <div id="advisor-status" class="hidden text-xs rounded-xl px-3 py-2"></div>

                <!-- ×˜×•×¤×¡ (×œ× × ×©×œ×— ×‘-HTML, ×¨×§ ×‘-JS) -->
                <form id="advisor-form" class="space-y-6" onsubmit="return false;">
                    <!-- ×©×•×¨×” 1: ×ª×§×¦×™×‘ + ×©× ×™× -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×ª×§×¦×™×‘ ××™× ×™××•× (â‚ª)</label>
                            <input id="budget_min" type="number" value="40000" min="0"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×ª×§×¦×™×‘ ××§×¡×™××•× (â‚ª)</label>
                            <input id="budget_max" type="number" value="65000" min="0"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×©× ×ª×•×Ÿ ××™× ×™××•×</label>
                                <input id="year_min" type="number" value="2015" min="1990"
                                       class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×©× ×ª×•×Ÿ ××§×¡×™××•×</label>
                                <input id="year_max" type="number" value="2019" min="1990"
                                       class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                            </div>
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 2: ×“×œ×§ / ×’×™×¨ / ×˜×•×¨×‘×• -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¡×•×’×™ ×“×œ×§ ××•×¢×“×¤×™×</label>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" class="fuel-input" value="×‘× ×–×™×Ÿ" checked>
                                    <span>×‘× ×–×™×Ÿ</span>
                                </label>
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" class="fuel-input" value="×”×™×‘×¨×™×“×™">
                                    <span>×”×™×‘×¨×™×“×™</span>
                                </label>
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" class="fuel-input" value="×“×™×–×œ">
                                    <span>×“×™×–×œ</span>
                                </label>
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" class="fuel-input" value="×—×©××œ×™">
                                    <span>×—×©××œ×™</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×ª×™×‘×ª ×”×™×œ×•×›×™×</label>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" class="gear-input" value="××•×˜×•××˜×™×ª" checked>
                                    <span>××•×˜×•××˜×™×ª</span>
                                </label>
                                <label class="inline-flex items-center gap-1">
                                    <input type="checkbox" class="gear-input" value="×™×“× ×™×ª">
                                    <span>×™×“× ×™×ª</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×˜×•×¨×‘×•</label>
                            <select id="turbo_choice_he"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>×œ× ××©× ×”</option>
                                <option>×›×Ÿ</option>
                                <option>×œ×</option>
                            </select>
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 3: ×©×™××•×© ×•×¡×’× ×•×Ÿ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2">
                            <label class="block text-xs mb-1 text-slate-600">×ª×™××•×¨ ×”×©×™××•×© ×‘×¨×›×‘</label>
                            <textarea id="main_use" rows="2"
                                      class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">× ×¡×™×¢×” ×™×•××™×•××™×ª ×œ×¢×‘×•×“×” ×•×˜×™×•×œ×™× ×§×¦×¨×™×</textarea>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">× ×¡×•×¢×” ×©× ×ª×™×ª (×§×´×)</label>
                                <input id="annual_km" type="number" value="15000" min="0" step="1000"
                                       class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×’×™×œ × ×”×’</label>
                                <input id="driver_age" type="number" value="21" min="16" max="100"
                                       class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                            </div>
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 4: ×¡×’× ×•×Ÿ × ×”×™×’×” / ××¨×›×‘ / ××•×©×‘×™× -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¡×’× ×•×Ÿ ××¨×›×‘ ××•×¢×“×£</label>
                            <select id="body_style"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>×›×œ×œ×™</option>
                                <option>×¡×“××Ÿ</option>
                                <option>×”××¦'×‘×§</option>
                                <option>×§×¨×•×¡××•×‘×¨/×’'×™×¤×•×Ÿ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¡×’× ×•×Ÿ × ×”×™×’×”</label>
                            <select id="driving_style"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>×¨×’×•×¢ ×•× ×™× ×•×—</option>
                                <option>×“×™× ××™ ×•×¡×¤×•×¨×˜×™×‘×™</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">××¡×¤×¨ ××§×•××•×ª</label>
                            <select id="seats_choice"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option>4</option>
                                <option selected>5</option>
                                <option>5+</option>
                            </select>
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 5: ×¡×“×¨ ×¢×“×™×¤×•×™×•×ª -->
                    <div class="border border-slate-100 rounded-2xl p-3 bg-slate-50">
                        <p class="text-xs font-medium text-slate-700 mb-2">×¡×“×¨ ×¢×“×™×¤×•×™×•×ª (1â€“5)</p>
                        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×××™× ×•×ª</label>
                                <input id="weight_reliability" type="number" min="1" max="5" value="5"
                                       class="w-full rounded-xl border border-slate-200 px-2 py-1.5 text-xs text-center">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×©××™×¨×ª ×¢×¨×š</label>
                                <input id="weight_resale" type="number" min="1" max="5" value="3"
                                       class="w-full rounded-xl border border-slate-200 px-2 py-1.5 text-xs text-center">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×—×™×¡×›×•×Ÿ ×‘×“×œ×§</label>
                                <input id="weight_fuel" type="number" min="1" max="5" value="4"
                                       class="w-full rounded-xl border border-slate-200 px-2 py-1.5 text-xs text-center">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">×‘×™×¦×•×¢×™×</label>
                                <input id="weight_performance" type="number" min="1" max="5" value="2"
                                       class="w-full rounded-xl border border-slate-200 px-2 py-1.5 text-xs text-center">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-slate-600">× ×•×—×•×ª</label>
                                <input id="weight_comfort" type="number" min="1" max="5" value="3"
                                       class="w-full rounded-xl border border-slate-200 px-2 py-1.5 text-xs text-center">
                            </div>
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 6: ××©×¤×—×” / ××˜×¢×Ÿ / ×‘×˜×™×—×•×ª / ×‘×™×˜×•×— -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×’×•×“×œ ××©×¤×—×”</label>
                            <select id="family_size"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option>1-2</option>
                                <option selected>3-4</option>
                                <option>5+</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¦×•×¨×š ×‘×ª× ××˜×¢×Ÿ</label>
                            <select id="cargo_need"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option>×§×˜×Ÿ</option>
                                <option selected>×‘×™× ×•× ×™</option>
                                <option>×’×“×•×œ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×—×•×‘×” ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×ª?</label>
                            <select id="safety_required"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>×›×Ÿ</option>
                                <option>×œ×</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¨××ª ××‘×–×•×¨</label>
                            <select id="trim_level"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option>×‘×¡×™×¡×™</option>
                                <option selected>×¡×˜× ×“×¨×˜×™</option>
                                <option>×¢×©×™×¨</option>
                            </select>
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 7: ×‘×™×˜×•×— / ×¢×‘×¨ × ×”×™×’×” -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×•×•×ª×§ ×¨×™×©×™×•×Ÿ (×©× ×™×)</label>
                            <input id="license_years" type="number" min="0" max="50" value="2"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">××™×Ÿ × ×”×’</label>
                            <select id="driver_gender"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>×–×›×¨</option>
                                <option>× ×§×‘×”</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¢×‘×¨ ×‘×™×˜×•×—×™</label>
                            <input id="insurance_history" type="text" value="×©× ×ª×™×™× ×œ×œ× ×ª×‘×™×¢×•×ª"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×“×•×—×•×ª / ×©×œ×™×œ×•×ª</label>
                            <select id="violations"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>××™×Ÿ</option>
                                <option>×©×œ×™×œ×” ×‘×¢×‘×¨</option>
                                <option>× ×§×•×“×•×ª ×¤×¢×™×œ×•×ª</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×”×ª×—×©×‘×•×ª ×‘×”×™×¦×¢ ×‘×©×•×§</label>
                            <select id="consider_supply"
                                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                                <option selected>×›×Ÿ</option>
                                <option>×œ×</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">×¦×‘×¢×™× ×œ×¤×¡×™×œ×” (××•×¤×¨×“×™× ×‘×¤×¡×™×§)</label>
                            <input id="excluded_colors" type="text" placeholder="×œ××©×œ: ×©×—×•×¨, ×œ×‘×Ÿ"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                    </div>

                    <!-- ×©×•×¨×” 8: ××—×™×¨×™ ×“×œ×§ / ×—×©××œ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">××—×™×¨ ×œ×™×˜×¨ ×“×œ×§ (â‚ª)</label>
                            <input id="fuel_price" type="number" step="0.1" min="1" max="20" value="7"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                        <div>
                            <label class="block text-xs mb-1 text-slate-600">××—×™×¨ ×—×©××œ ×œ×§×•×˜×´×© (â‚ª)</label>
                            <input id="electricity_price" type="number" step="0.01" min="0.1" max="5" value="0.65"
                                   class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-900/10">
                        </div>
                    </div>
                </form>
            </section>

            <!-- ×ª×•×¦××•×ª -->
            <section class="space-y-4">
                <div id="advisor-search-info" class="hidden bg-slate-900 text-slate-50 rounded-2xl p-4 text-xs space-y-2">
                    <div class="font-semibold">×¡×˜×˜×•×¡ ×—×™×¤×•×© ×¨×©×ª</div>
                    <pre id="advisor-search-queries" class="whitespace-pre-wrap text-[11px] leading-relaxed"></pre>
                </div>

                <div id="advisor-results" class="space-y-3"></div>
            </section>
        {% endif %}
    </main>

    <script>
    (function() {
        const submitBtn = document.getElementById('advisor-submit-btn');
        const statusBox = document.getElementById('advisor-status');
        const resultsContainer = document.getElementById('advisor-results');
        const searchInfoBox = document.getElementById('advisor-search-info');
        const searchQueriesPre = document.getElementById('advisor-search-queries');

        if (!submitBtn) return; // ×œ× ×‘×¢×œ ×”××ª×¨

        function showStatus(text, type) {
            if (!statusBox) return;
            statusBox.classList.remove('hidden');
            statusBox.textContent = text || '';
            statusBox.className =
                'text-xs rounded-xl px-3 py-2 ' +
                (type === 'error'
                    ? 'bg-red-50 text-red-700 border border-red-200'
                    : type === 'ok'
                        ? 'bg-emerald-50 text-emerald-700 border border-emerald-200'
                        : 'bg-slate-50 text-slate-700 border border-slate-200');
        }

        function clearResults() {
            if (resultsContainer) {
                resultsContainer.innerHTML = '';
            }
            if (searchInfoBox) {
                searchInfoBox.classList.add('hidden');
                searchQueriesPre.textContent = '';
            }
        }

        function collectValues() {
            const val = id => document.getElementById(id) ? document.getElementById(id).value : '';

            const budget_min = parseFloat(val('budget_min') || '0');
            const budget_max = parseFloat(val('budget_max') || '0');
            const year_min = parseInt(val('year_min') || '2015', 10);
            const year_max = parseInt(val('year_max') || '2019', 10);

            const fuels_he = Array.from(document.querySelectorAll('.fuel-input:checked')).map(x => x.value);
            const gears_he = Array.from(document.querySelectorAll('.gear-input:checked')).map(x => x.value);
            const turbo_choice_he = val('turbo_choice_he') || '×œ× ××©× ×”';

            const payload = {
                budget_min,
                budget_max,
                year_min,
                year_max,
                fuels_he,
                gears_he,
                turbo_choice_he,
                main_use: val('main_use'),
                annual_km: parseInt(val('annual_km') || '15000', 10),
                driver_age: parseInt(val('driver_age') || '21', 10),
                body_style: val('body_style'),
                driving_style: val('driving_style'),
                seats_choice: val('seats_choice'),
                weight_reliability: parseInt(val('weight_reliability') || '5', 10),
                weight_resale: parseInt(val('weight_resale') || '3', 10),
                weight_fuel: parseInt(val('weight_fuel') || '4', 10),
                weight_performance: parseInt(val('weight_performance') || '2', 10),
                weight_comfort: parseInt(val('weight_comfort') || '3', 10),
                family_size: val('family_size'),
                cargo_need: val('cargo_need'),
                safety_required: val('safety_required'),
                trim_level: val('trim_level'),
                license_years: parseInt(val('license_years') || '2', 10),
                driver_gender: val('driver_gender'),
                insurance_history: val('insurance_history'),
                violations: val('violations'),
                consider_supply: val('consider_supply'),
                excluded_colors: val('excluded_colors'),
                fuel_price: parseFloat(val('fuel_price') || '7'),
                electricity_price: parseFloat(val('electricity_price') || '0.65'),
            };

            return payload;
        }

        function renderResults(data) {
            clearResults();
            if (!data || !Array.isArray(data.cars) || data.cars.length === 0) {
                showStatus('×œ× ×”×ª×§×‘×œ×• ×¨×›×‘×™×.', 'error');
                return;
            }

            if (data.search_info && Array.isArray(data.search_info.search_queries) && data.search_info.search_queries.length > 0) {
                searchInfoBox.classList.remove('hidden');
                searchQueriesPre.textContent = data.search_info.search_queries.join('\n');
            }

            data.cars.forEach((car, idx) => {
                const methods = (data.methods && data.methods[idx]) || {};
                const card = document.createElement('div');
                card.className =
                    'bg-white border border-slate-200 rounded-2xl p-4 shadow-sm flex flex-col gap-2 text-xs sm:text-sm';

                const title = document.createElement('div');
                title.className = 'flex items-center justify-between gap-2';
                const name = document.createElement('div');
                name.className = 'font-semibold text-slate-900';
                const brand = car['××•×ª×’'] || '';
                const model = car['×“×’×'] || '';
                const year = car['×©× ×”'] || '';
                name.textContent = `${brand} ${model} ${year}`.trim();
                const fitBadge = document.createElement('div');
                fitBadge.className =
                    'inline-flex items-center gap-1 rounded-full bg-slate-900 text-white text-[11px] px-3 py-1';
                const fitScore = car['×¦×™×•×Ÿ ×”×ª×××” (0â€“100)'] ?? car['fit_score'] ?? '';
                fitBadge.textContent = fitScore !== '' ? `×”×ª×××”: ${fitScore}` : '×”×ª×××”';

                title.appendChild(name);
                title.appendChild(fitBadge);

                const meta = document.createElement('div');
                meta.className = 'text-[11px] text-slate-600 flex flex-wrap gap-x-3 gap-y-1';
                const fuel = car['×“×œ×§'] || '';
                const gear = car['×ª×™×‘×”'] || '';
                const turbo = car['×˜×•×¨×‘×•'] || '';
                meta.innerHTML = `
                    <span>×“×œ×§: <span class="font-medium">${fuel}</span></span>
                    <span> | </span>
                    <span>×’×™×¨: <span class="font-medium">${gear}</span></span>
                    <span> | </span>
                    <span>×˜×•×¨×‘×•: <span class="font-medium">${turbo}</span></span>
                `;

                const mainRow = document.createElement('div');
                mainRow.className = 'grid grid-cols-2 sm:grid-cols-4 gap-2 text-[11px] text-slate-700';
                const price = car['×˜×•×•×— ××—×™×¨ (â‚ª)'] ?? '';
                const totalAnnual = car['×¢×œ×•×ª ×›×•×œ×œ×ª ×©× ×ª×™×ª (â‚ª)'] ?? '';
                const reliability = car['×××™× ×•×ª'] ?? '';
                const resale = car['×©××™×¨×ª ×¢×¨×š'] ?? '';
                mainRow.innerHTML = `
                    <div>×˜×•×•×— ××—×™×¨: <span class="font-medium">${price}</span></div>
                    <div>×¢×œ×•×ª ×©× ×ª×™×ª: <span class="font-medium">${totalAnnual}</span></div>
                    <div>×××™× ×•×ª: <span class="font-medium">${reliability}</span>/10</div>
                    <div>×©××™×¨×ª ×¢×¨×š: <span class="font-medium">${resale}</span>/10</div>
                `;

                const extra = document.createElement('details');
                extra.className = 'mt-2 rounded-xl bg-slate-50 px-3 py-2';
                const summary = document.createElement('summary');
                summary.className = 'cursor-pointer text-[11px] text-slate-700 font-medium';
                summary.textContent = '×”×¡×‘×¨ ××œ× ×•×©×™×˜×•×ª ×—×™×©×•×‘';
                extra.appendChild(summary);

                const extraContent = document.createElement('div');
                extraContent.className = 'mt-2 space-y-1 text-[11px] text-slate-700';

                if (car['×¢×œ×•×ª ×“×œ×§ ×©× ×ª×™×ª (â‚ª)'] || car['×¢×œ×•×ª ×—×©××œ ×©× ×ª×™×ª (â‚ª)'] || car['annual_energy_cost']) {
                    const energy = document.createElement('div');
                    const costEnergy = car['×¢×œ×•×ª ×“×œ×§ ×©× ×ª×™×ª (â‚ª)'] || car['annual_energy_cost'] || '';
                    energy.textContent = `×¢×œ×•×ª ×× ×¨×’×™×” ××©×•×¢×¨×ª ×œ×©× ×”: ${costEnergy} â‚ª`;
                    extraContent.appendChild(energy);
                }

                if (car['×‘×™×¦×•×¢×™×']) {
                    const perf = document.createElement('div');
                    perf.textContent = `×‘×™×¦×•×¢×™×: ${car['×‘×™×¦×•×¢×™×']}/10`;
                    extraContent.appendChild(perf);
                }

                if (car['×‘×˜×™×—×•×ª']) {
                    const saf = document.createElement('div');
                    saf.textContent = `×‘×˜×™×—×•×ª: ${car['×‘×˜×™×—×•×ª']}/10`;
                    extraContent.appendChild(saf);
                }

                if (methods && Object.keys(methods).length > 0) {
                    const methodsTitle = document.createElement('div');
                    methodsTitle.className = 'mt-2 font-semibold text-[11px] text-slate-800';
                    methodsTitle.textContent = '×©×™×˜×•×ª ×—×™×©×•×‘ (×œ×¤×™ Gemini):';
                    extraContent.appendChild(methodsTitle);

                    Object.entries(methods).forEach(([key, val]) => {
                        const row = document.createElement('div');
                        row.textContent = `${key}: ${val}`;
                        extraContent.appendChild(row);
                    });
                }

                extra.appendChild(extraContent);

                card.appendChild(title);
                card.appendChild(meta);
                card.appendChild(mainRow);
                card.appendChild(extra);

                resultsContainer.appendChild(card);
            });
        }

        submitBtn.addEventListener('click', function() {
            clearResults();
            const payload = collectValues();

            if (!payload.budget_min || !payload.budget_max || payload.budget_max < payload.budget_min) {
                showStatus('×‘×“×•×§ ××ª ×˜×•×•×— ×”×ª×§×¦×™×‘.', 'error');
                return;
            }

            showStatus('×©×•×œ×— ×‘×§×©×” ×œ-Gemini 3 + ×—×™×¤×•×© ×¨×©×ª...', 'info');
            submitBtn.disabled = true;

            fetch('{{ url_for("recommendations_submit") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            })
            .then(async (res) => {
                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.ok) {
                    const errMsg = data.error || '×©×’×™××” ×›×œ×œ×™×ª ××”×©×¨×ª.';
                    showStatus(errMsg, 'error');
                    submitBtn.disabled = false;
                    return;
                }
                showStatus('âœ… ×”×ª×§×‘×œ×• ×ª×•×¦××•×ª. ××¦×™×’ ×¨×›×‘×™× ××•××œ×¦×™×...', 'ok');
                renderResults(data);
                submitBtn.disabled = false;
            })
            .catch((err) => {
                console.error(err);
                showStatus('×©×’×™××” ×‘×¨××ª ×¨×©×ª ××• ×“×¤×“×¤×Ÿ.', 'error');
                submitBtn.disabled = false;
            });
        });
    })();
    </script>
</body>
</html>
