<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <title>yedaarechevAI â€“ ×”×“×©×‘×•×¨×“ ×©×œ×™</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#EC4899',
                        dark: '#0F172A',
                        'dark-lighter': '#1E293B'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Heebo', system-ui, -apple-system, sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
            margin: 0;
            -webkit-tap-highlight-color: transparent; /* ××¡×™×¨ ×”×‘×”×•×‘ ×›×—×•×œ ×‘×œ×—×™×¦×” ×‘××•×‘×™×™×œ */
        }

        /* ×¢×™×¦×•×‘ ×¤×¡ ×’×œ×™×œ×” ×›×œ×œ×™ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        /* ×”×¡×ª×¨×ª ×¤×¡ ×’×œ×™×œ×” ×œ×˜××‘×™× ×‘××•×‘×™×™×œ ×œ×©××™×¨×” ×¢×œ ×¢×™×¦×•×‘ × ×§×™ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* ×¡×’× ×•×Ÿ ×œ×˜××‘×™× ×¤×¢×™×œ×™× */
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active {
            background-color: #312e81; /* indigo-900 */
            border-color: #6366F1;
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.25);
        }
        
        /* ×× ×™××¦×™×™×ª ×›× ×™×¡×” ×œ×ª×•×›×Ÿ */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<body class="bg-dark text-slate-200 min-h-screen flex flex-col antialiased">

<header class="sticky top-0 z-40 bg-dark/90 backdrop-blur-lg border-b border-slate-800/80">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <a href="{{ url_for('index') }}" class="flex items-center">
            <h1 class="text-xl md:text-2xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-primary via-purple-500 to-secondary">
                yedaarechevAI
            </h1>
        </a>

        <div class="flex items-center gap-3 text-sm font-medium">
            {% if user and user.is_authenticated %}
                <span class="text-slate-400 hidden sm:inline">{{ user.name.split(' ')[0] if user.name else '××•×¨×—' }}</span>
                <a href="{{ url_for('logout') }}" class="p-2 rounded-full text-slate-300 hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </a>
            {% else %}
                <a href="{{ url_for('login') }}" class="px-4 py-1.5 rounded-full bg-primary text-white text-sm font-bold">×”×ª×—×‘×¨×•×ª</a>
            {% endif %}
        </div>
    </div>
</header>

<main class="flex-grow relative container mx-auto px-4 py-8 pb-24">
    <div class="mb-8">
        <h2 class="text-2xl md:text-3xl font-extrabold text-white mb-2">×”×—×™×¤×•×©×™× ×©×œ×™</h2>
        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
            <span class="whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-800 text-slate-100 border border-slate-600">
                ×”×™×¡×˜×•×¨×™×™×ª ×‘×“×™×§×•×ª
            </span>
            <span class="whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-900/50 text-slate-500 border border-slate-700/50">
                ×”××œ×¦×•×ª (×‘×§×¨×•×‘)
            </span>
        </div>
    </div>

    <div class="relative z-10">
        {% if searches and searches|length > 0 %}
            <div class="grid gap-4">
                {% for s in searches %}
                    <article
                        class="bg-dark-lighter/80 border border-slate-700/60 rounded-xl p-4 active:scale-[0.98] transition-transform cursor-pointer shadow-lg"
                        data-search-id="{{ s.id }}"
                        onclick="openDetails('{{ s.id }}')"
                    >
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                    {{ s.make|title }} {{ s.model|title }}
                                    <span class="text-primary text-base font-normal">{{ s.year }}</span>
                                </h3>
                                <div class="flex items-center gap-2 mt-1 text-xs text-slate-400">
                                    <span>{{ s.timestamp }}</span>
                                    {% if s.mileage_range %}
                                        <span>â€¢</span>
                                        <span>{{ s.mileage_range }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% set base = s.data.get('base_score_calculated') %}
                            {% if base %}
                                {% set base_num = (base|string).split()[0]|float(default=0) %}
                                {% if base_num >= 80 %} {% set score_col = 'text-emerald-400' %}
                                {% elif base_num >= 60 %} {% set score_col = 'text-amber-400' %}
                                {% else %} {% set score_col = 'text-rose-400' %}
                                {% endif %}
                                <div class="text-2xl font-black {{ score_col }}">
                                    {{ base_num|round(0, 'floor')|int }}
                                </div>
                            {% endif %}
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12 bg-dark-lighter/40 rounded-2xl border border-slate-800">
                <p class="text-slate-400 mb-4">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ.</p>
                <a href="{{ url_for('index') }}" class="px-6 py-2 rounded-full bg-primary text-white font-bold text-sm">×”×ª×—×œ ×‘×“×™×§×”</a>
            </div>
        {% endif %}
    </div>
</main>

<div id="details-overlay" class="fixed inset-0 bg-dark z-50 hidden flex flex-col animate-fadeIn">
    <div class="flex items-center justify-between px-4 py-3 bg-dark-lighter border-b border-slate-700 shrink-0 shadow-md z-50">
        <div>
            <h3 id="details-title" class="text-lg font-bold text-white leading-tight"></h3>
            <p id="details-meta" class="text-xs text-slate-400 mt-0.5"></p>
        </div>
        <button id="details-close-btn" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-800 text-white border border-slate-600 active:bg-slate-700">
            âœ•
        </button>
    </div>

    <div id="details-content" class="flex-1 overflow-y-auto overflow-x-hidden bg-dark">
        </div>
</div>

<script>
    // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
    const overlay = document.getElementById('details-overlay');
    const content = document.getElementById('details-content');
    const titleEl = document.getElementById('details-title');
    const metaEl = document.getElementById('details-meta');

    // ×¡×’×™×¨×ª ×”××•×“××œ
    document.getElementById('details-close-btn').addEventListener('click', () => {
        overlay.classList.add('hidden');
        document.body.style.overflow = ''; // ×©×—×¨×•×¨ ×’×œ×™×œ×”
    });

    // ×¤×•× ×§×¦×™×™×ª ×¤×ª×™×—×” ×•×©×œ×™×¤×ª × ×ª×•× ×™×
    async function openDetails(id) {
        try {
            // ××™×¤×•×¡ ×•×”×¦×’×ª ×œ×•××“×¨
            content.innerHTML = '<div class="p-8 text-center text-slate-500 flex flex-col items-center gap-2"><div class="w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // × ×¢×™×œ×ª ×’×œ×™×œ×”

            const res = await fetch(`/search-details/${id}`);
            const payload = await res.json();
            
            if (!res.ok || payload.error) {
                content.innerHTML = '<div class="p-8 text-center text-red-400">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</div>';
                return;
            }

            const meta = payload.meta || {};
            const data = payload.data || {};

            // ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª
            titleEl.textContent = `${meta.make} ${meta.model} (${meta.year})`;
            metaEl.textContent = `${meta.fuel_type || ''} â€¢ ${meta.transmission || ''}`;

            // ×—×™×©×•×‘ ×¦×™×•×Ÿ ×•×¦×‘×¢
            const baseRaw = data.base_score_calculated ?? null;
            let baseNum = null;
            if (baseRaw != null) {
                const m = String(baseRaw).match(/-?\d+(\.\d+)?/);
                baseNum = m ? parseFloat(m[0]) : 0;
            }
            let scoreBg = 'bg-rose-500';
            if (baseNum >= 80) scoreBg = 'bg-emerald-500';
            else if (baseNum >= 60) scoreBg = 'bg-amber-500';

            // ×¢×™×‘×•×“ ×¨×©×™××•×ª
            const commonIssues = Array.isArray(data.common_issues) ? data.common_issues : [];
            const issuesWithCosts = Array.isArray(data.issues_with_costs) ? data.issues_with_costs : [];
            const competitors = Array.isArray(data.common_competitors_brief) ? data.common_competitors_brief : [];
            const sources = Array.isArray(data.sources) ? data.sources : [];

            // ×‘× ×™×™×ª ×”-HTML ×”×¤× ×™××™ ×¢× ×”×˜××‘×™× Sticky
            content.innerHTML = `
                <div class="pb-12">
                    <div class="p-6 text-center bg-gradient-to-b from-dark-lighter to-dark border-b border-slate-800 relative">
                        <div class="absolute inset-0 bg-primary/5 pointer-events-none"></div>
                        
                        <div class="relative z-10 inline-flex flex-col items-center justify-center w-24 h-24 rounded-full ${scoreBg} text-white shadow-[0_0_30px_rgba(0,0,0,0.5)] mb-4">
                            <span class="text-4xl font-black">${Math.round(baseNum)}</span>
                            <span class="text-[10px] font-medium opacity-90 uppercase tracking-wide">×¦×™×•×Ÿ ×××™× ×•×ª</span>
                        </div>
                        <p class="relative z-10 text-sm text-slate-300 px-2 leading-relaxed max-w-sm mx-auto">
                            ${data.reliability_summary_simple || '××™×Ÿ ×¡×™×›×•× ×–××™×Ÿ.'}
                        </p>
                    </div>

                    <div class="sticky top-0 bg-dark/95 backdrop-blur-md z-40 border-b border-slate-700/50 py-3 px-2 overflow-x-auto no-scrollbar whitespace-nowrap flex gap-3 shadow-lg">
                        <button onclick="switchTab('summary')" class="tab-btn active px-4 py-2 rounded-lg text-sm font-bold border border-slate-600/50 text-slate-300 bg-slate-800/50 flex items-center gap-2">
                            <span>ğŸ“„</span> ×¡×™×›×•×
                        </button>
                        <button onclick="switchTab('faults')" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold border border-slate-600/50 text-slate-300 bg-slate-800/50 flex items-center gap-2">
                            <span>ğŸ”§</span> ×ª×§×œ×•×ª
                        </button>
                        <button onclick="switchTab('costs')" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold border border-slate-600/50 text-slate-300 bg-slate-800/50 flex items-center gap-2">
                            <span>ğŸ’°</span> ×¢×œ×•×™×•×ª
                        </button>
                        <button onclick="switchTab('competitors')" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold border border-slate-600/50 text-slate-300 bg-slate-800/50 flex items-center gap-2">
                            <span>ğŸ†š</span> ××ª×—×¨×™×
                        </button>
                        <button onclick="switchTab('sources')" class="tab-btn px-4 py-2 rounded-lg text-sm font-bold border border-slate-600/50 text-slate-300 bg-slate-800/50 flex items-center gap-2">
                            <span>ğŸ”—</span> ××§×•×¨×•×ª
                        </button>
                    </div>

                    <div class="p-4 sm:p-6 min-h-[300px]">
                        
                        <div id="tab-summary" class="tab-content active animate-fadeIn">
                            <div class="bg-dark-lighter rounded-2xl p-5 border border-slate-700/50 shadow-sm">
                                <h4 class="text-primary font-bold mb-3 text-base flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    × ×™×ª×•×— ××§×¦×•×¢×™ ××¢××™×§
                                </h4>
                                <p class="text-sm text-slate-300 leading-7 whitespace-pre-line">
                                    ${data.reliability_summary || '××™×Ÿ ××™×“×¢ × ×•×¡×£.'}
                                </p>
                            </div>
                        </div>

                        <div id="tab-faults" class="tab-content animate-fadeIn">
                            <div class="space-y-3">
                                ${commonIssues.length ? commonIssues.map(issue => `
                                    <div class="flex items-start gap-3 bg-dark-lighter p-4 rounded-xl border border-slate-700/50 shadow-sm">
                                        <span class="text-red-400 mt-0.5 shrink-0">âš ï¸</span>
                                        <p class="text-sm text-slate-200 leading-relaxed">${issue}</p>
                                    </div>
                                `).join('') : '<div class="p-4 text-center text-slate-500 bg-dark-lighter rounded-xl">×œ× ×“×•×•×—×• ×ª×§×œ×•×ª ××™×•×—×“×•×ª.</div>'}
                            </div>
                        </div>

                        <div id="tab-costs" class="tab-content animate-fadeIn">
                            ${data.avg_repair_cost_ILS ? `
                                <div class="bg-gradient-to-r from-primary/10 to-primary/5 border border-primary/20 p-5 rounded-2xl mb-5 text-center">
                                    <div class="text-xs text-primary font-bold uppercase tracking-wider mb-1">×¢×œ×•×ª ××—×–×§×” ×©× ×ª×™×ª ×××•×¦×¢×ª</div>
                                    <div class="text-3xl font-black text-white">${data.avg_repair_cost_ILS} â‚ª</div>
                                </div>
                            ` : ''}
                            
                            <div class="space-y-3">
                                ${issuesWithCosts.length ? issuesWithCosts.map(item => `
                                    <div class="flex items-center justify-between bg-dark-lighter p-4 rounded-xl border border-slate-700/50 shadow-sm">
                                        <div class="pr-2">
                                            <div class="text-sm text-slate-200 font-bold mb-0.5">${item.issue}</div>
                                            <div class="text-[10px] text-slate-500">${item.source || '××§×•×¨ ×œ× ×¦×•×™×Ÿ'}</div>
                                        </div>
                                        <div class="shrink-0 text-right">
                                            <div class="text-sm font-bold text-white bg-slate-700/80 px-2.5 py-1 rounded-lg border border-slate-600">${item.avg_cost_ILS} â‚ª</div>
                                            <div class="text-[10px] text-slate-400 mt-1 mr-1">${item.severity || ''}</div>
                                        </div>
                                    </div>
                                `).join('') : '<p class="text-sm text-slate-400 text-center">××™×Ÿ ×¤×™×¨×•×˜ ×¢×œ×•×™×•×ª.</p>'}
                            </div>
                        </div>

                        <div id="tab-competitors" class="tab-content animate-fadeIn">
                            <div class="space-y-3">
                                ${competitors.length ? competitors.map(comp => `
                                    <div class="bg-dark-lighter p-4 rounded-xl border border-slate-700/50 shadow-sm">
                                        <h5 class="font-bold text-white mb-2 flex items-center gap-2">
                                            <span class="w-2 h-2 rounded-full bg-secondary"></span>
                                            ${comp.model}
                                        </h5>
                                        <p class="text-xs text-slate-300 leading-relaxed pl-4 border-r-2 border-slate-700 pr-3">${comp.brief_summary}</p>
                                    </div>
                                `).join('') : '<p class="text-slate-500 text-center">××™×Ÿ × ×ª×•× ×™ ××ª×—×¨×™×.</p>'}
                            </div>
                        </div>

                        <div id="tab-sources" class="tab-content animate-fadeIn">
                            <div class="bg-dark-lighter p-5 rounded-2xl border border-slate-700/50">
                                <ul class="space-y-3">
                                    ${sources.length ? sources.map(s => `
                                        <li class="flex items-start gap-2 overflow-hidden">
                                            <span class="text-slate-500 mt-1">ğŸ”—</span>
                                            <a href="${s}" target="_blank" class="text-sm text-primary hover:underline truncate w-full dir-ltr text-left">${s}</a>
                                        </li>
                                    `).join('') : '<li class="text-slate-500 text-center text-sm">××™×Ÿ ××§×•×¨×•×ª ×–××™× ×™×.</li>'}
                                </ul>
                                ${data.source_tag ? `<div class="mt-6 pt-4 border-t border-slate-700 text-[10px] text-slate-500 text-center">${data.source_tag}</div>` : ''}
                            </div>
                        </div>

                    </div>
                </div>
            `;

        } catch (err) {
            console.error(err);
            content.innerHTML = '<div class="p-8 text-center text-red-400">×©×’×™××” ×œ× ×¦×¤×•×™×”</div>';
        }
    }

    // ×¤×•× ×§×¦×™×™×ª ×”×—×œ×¤×ª ×˜××‘×™×
    window.switchTab = function(name) {
        // ××™×¤×•×¡ ×›×¤×ª×•×¨×™×
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-slate-700', 'border-primary', 'text-white');
            btn.classList.add('border-slate-600/50', 'text-slate-300', 'bg-slate-800/50');
        });
        
        // ××™×¤×•×¡ ×ª×›× ×™×
        document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));

        // ×”×¤×¢×œ×ª ×”× ×•×›×—×™
        const activeBtn = event.currentTarget;
        activeBtn.classList.remove('border-slate-600/50', 'text-slate-300', 'bg-slate-800/50');
        activeBtn.classList.add('active', 'bg-slate-700', 'border-primary', 'text-white');
        
        document.getElementById(`tab-${name}`).classList.add('active');
        
        // ×’×œ×™×œ×” ×—×–×¨×” ×œ××¢×œ×” ×× ×”××©×ª××© ×œ××˜×” ××“×™
        const contentContainer = document.getElementById('details-content');
        if (contentContainer.scrollTop > 300) {
            contentContainer.scrollTo({ top: 280, behavior: 'smooth' });
        }
    }
</script>

</body>
</html>
