<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>×”×—×™×¤×•×©×™× ×©×œ×™ â€“ yedaarechevAI</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>

  <style>
    :root{ --bg-dark:#0F172A; --text-light:#E2E8F0; --primary:#6366F1; --secondary:#EC4899; }
    body{
      font-family:'Heebo',system-ui,-apple-system,sans-serif;
      background:var(--bg-dark);
      color:var(--text-light);
    }
    .fade-in{ animation:fadeIn .6s cubic-bezier(.4,0,.2,1) forwards; opacity:0 }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:none} }
    .card{ background:rgba(30,41,59,.6); border:1px solid rgba(51,65,85,.5); border-radius:1.75rem; }
    .chip{ background:rgba(99,102,241,.12); border:1px solid rgba(99,102,241,.35); }
    .btn{ background-image:linear-gradient(90deg,var(--primary),var(--secondary)); }
    .btn:hover{ filter:brightness(1.05) }
    .backdrop{ backdrop-filter:saturate(130%) blur(8px) }

    /* --- ×ª×™×§×•×Ÿ ×¢×™×¦×•×‘ ×œ× ×™×™×“ --- */
    .modal-mask {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(2, 6, 23, 0.9);
      display: none; /* × ×¤×ª×— ×¢"×™ JS ×‘-flex */
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 10px;
      backdrop-filter: blur(4px);
    }
    
    .modal {
      width: 100%;             
      max-width: 800px;        
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      background: #0f172a;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 1.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }

    ::-webkit-scrollbar{ width:6px; height: 6px; }
    ::-webkit-scrollbar-track{ background:#1e293b }
    ::-webkit-scrollbar-thumb{ background:#475569; border-radius:3px }
    ::-webkit-scrollbar-thumb:hover{ background:#64748b }

    /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™ ×˜××‘×™× */
    .tab-btn {
      padding: 0.75rem 1rem;
      font-weight: 700;
      font-size: 0.9rem;
      border-bottom: 2px solid transparent;
      color: #94a3b8;
      white-space: nowrap;
      background: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #e2e8f0; background: rgba(255,255,255,0.05); }
    .tab-btn.active { color: #818cf8; border-color: #6366F1; background: rgba(99,102,241,0.1); }
  </style>

  <script>
    tailwind.config = {
      darkMode:'class',
      theme:{ extend:{ colors:{ primary:'#6366F1', secondary:'#EC4899', dark:'#0F172A', 'dark-lighter':'#1E293B', success:'#10B981', warning:'#F59E0B', danger:'#EF4444' } } }
    }
    
    // --- ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª ×›×“×™ ×œ×”×‘×˜×™×— ×©×”×›×¤×ª×•×¨×™× ×™×¢×‘×“×• ---
    
    function switchTab(tabName) {
      // ×”×¡×ª×¨×ª ×›×œ ×”×ª×›× ×™×
      const ids = ["summary", "faults", "costs", "competitors", "sources"];
      ids.forEach(id => {
        const el = document.getElementById("tab-" + id);
        if (el) el.style.display = (id === tabName) ? "block" : "none";
      });

      // ×¢×“×›×•×Ÿ ×¢×™×¦×•×‘ ×”×›×¤×ª×•×¨×™×
      document.querySelectorAll(".tab-btn").forEach(btn => {
        // ×‘×“×™×§×” ×œ×¤×™ ×”×˜×§×¡×˜ ×‘×ª×•×š ×”-onclick ××• ×œ×¤×™ ID ×× ×”×™×™× ×• ×©××™×
        // ×”×©×™×˜×” ×”×›×™ ×‘×˜×•×—×” ×›××Ÿ ×”×™× ×œ×”×¡×™×¨ active ××›×•×œ× ×•×œ×”×•×¡×™×£ ×œ×–×” ×©× ×œ×—×¥
        // ××‘×œ ××›×™×•×•×Ÿ ×©×”×§×¨×™××” ×‘××” ×-onclick, ×× ×—× ×• ×¦×¨×™×›×™× ×œ×–×”×•×ª ××ª ×”×›×¤×ª×•×¨
        // × ×©×ª××© ×‘-dataset ×œ×¦×•×¨×š ×”×–×™×”×•×™ ×”×—×–×•×ª×™
        if (btn.dataset.tab === tabName) {
            btn.classList.add("active");
        } else {
            btn.classList.remove("active");
        }
      });
    }

    function closeModal() {
      const mask = document.getElementById('modal-mask');
      if (mask) {
        mask.style.display = 'none';
        document.body.style.overflow = '';
      }
    }
  </script>
</head>
<body class="min-h-screen flex flex-col">

  <header class="sticky top-0 z-50 bg-dark/80 backdrop-blur-lg border-b border-slate-800/80">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <a href="/" class="flex items-center space-x-2 space-x-reverse group">
        <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-primary via-purple-500 to-secondary">
          yedaarechevAI
        </h1>
      </a>
      <div class="flex items-center gap-3 sm:gap-6 text-sm font-medium">
        <div class="hidden md:flex items-center gap-2 text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/></svg>
          <span>{{ user.name.split(' ')[0] if user.name else '××•×¨×—' }}</span>
        </div>
        <a href="/" class="px-4 py-2 rounded-full text-slate-300 hover:text-white hover:bg-white/10 transition">×—×–×¨×” ×œ×—×™×¤×•×©</a>
        <a href="/logout" class="px-4 py-2 rounded-full text-slate-300 hover:text-white hover:bg-white/10 transition">×”×ª× ×ª×§</a>
      </div>
    </div>
  </header>

  <main class="flex-grow relative container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[1000px] h-[1000px] opacity-20 pointer-events-none"
         style="background: radial-gradient(circle, rgba(99,102,241,0.25) 0%, rgba(15,23,42,0) 70%);">
    </div>

    <div class="relative z-10 mb-10 fade-in">
      <h2 class="text-4xl md:text-6xl font-extrabold mb-4 text-white">×”×—×™×¤×•×©×™× ×©×œ×™</h2>
      <p class="text-slate-400 text-lg">×›×œ ×”×“×•×—×•×ª ×©×”×¤×§×ª â€“ ×‘×œ×—×™×¦×” ××—×ª ×œâ€œ×”×¦×’ ×¤×¨×˜×™×â€.</p>
    </div>

    {% if searches and searches|length > 0 %}
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 fade-in">
        {% for s in searches %}
          {% set base_score = (s.data.base_score_calculated if s.data and 'base_score_calculated' in s.data else None) %}
          <div class="card p-6 backdrop">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h3 class="text-xl font-extrabold text-white">
                  {{ s.make|title }} {{ s.model|title }} <span class="text-slate-400">({{ s.year }})</span>
                </h3>
                <div class="mt-1 text-sm text-slate-400">{{ s.timestamp }}</div>
              </div>
              <div class="flex flex-col items-center">
                <div class="rounded-xl px-3 py-1 chip text-sm font-semibold text-indigo-300">×¦×™×•×Ÿ</div>
                <div class="mt-2 text-3xl font-black {{ 'text-primary' if base_score and base_score|float >= 70 else 'text-slate-200' }}">
                  {{ base_score if base_score else 'â€”' }}
                </div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2 text-xs">
              {% if s.mileage_range %}<span class="chip px-3 py-1 rounded-full text-indigo-300">×§×´×: {{ s.mileage_range }}</span>{% endif %}
              {% if s.fuel_type %}<span class="chip px-3 py-1 rounded-full text-indigo-300">×“×œ×§: {{ s.fuel_type }}</span>{% endif %}
              {% if s.transmission %}<span class="chip px-3 py-1 rounded-full text-indigo-300">×’×™×¨: {{ s.transmission }}</span>{% endif %}
            </div>

            <p class="mt-4 text-slate-300 line-clamp-3">
              {% if s.data and s.data.reliability_summary %}
                {{ s.data.reliability_summary[:180] }}{% if s.data.reliability_summary|length > 180 %}â€¦{% endif %}
              {% else %}××™×Ÿ ×¡×™×›×•× ×–××™×Ÿ ×œ×ª×¦×•×’×” ××§×“×™××”.{% endif %}
            </p>

            <div class="mt-6 flex items-center justify-between">
              <button
                class="show-details btn text-white px-5 py-3 rounded-xl font-bold shadow-lg shadow-primary/20 hover:shadow-primary/40 transition"
                data-id="{{ s.id }}">
                ×”×¦×’ ×¤×¨×˜×™×
              </button>
              <a class="text-sm text-slate-400 hover:text-indigo-300 underline underline-offset-4"
                 href="/" title="×‘×“×•×§ ×¨×›×‘ × ×•×¡×£">×‘×“×™×§×” ×—×“×©×”</a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card p-10 text-center fade-in">
        <div class="text-6xl mb-4">ğŸ”</div>
        <h3 class="text-2xl font-bold text-white mb-2">×¢×“×™×™×Ÿ ×œ× ×‘×™×¦×¢×ª ×—×™×¤×•×©×™×</h3>
        <p class="text-slate-400 mb-6">×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª ×›×“×™ ×œ×‘×¦×¢ ××ª ×”×—×™×¤×•×© ×”×¨××©×•×Ÿ ×©×œ×š.</p>
        <a href="/" class="btn inline-flex items-center justify-center px-8 py-4 text-lg font-bold text-white rounded-2xl hover:scale-[1.02] transition">×—×–×¨×” ×œ×—×™×¤×•×©</a>
      </div>
    {% endif %}
  </main>

  <div id="modal-mask" class="modal-mask" onclick="if(event.target===this) closeModal()">
    <div class="modal" id="modal-content-box">
      
      <div class="px-4 py-4 md:px-6 md:py-5 flex items-center justify-between border-b border-slate-700/50 shrink-0 bg-dark-lighter/80">
        <h4 id="modal-title" class="text-lg md:text-2xl font-extrabold text-white">×¤×¨×˜×™ ×—×™×¤×•×©</h4>
        <button onclick="closeModal()" class="text-slate-300 hover:text-white p-2 rounded-lg hover:bg-white/10 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811l.084.073L12 10.575l5.691-5.691a1 1 0 0 1 1.403 1.422L13.425 12l5.67 5.67a1 1 0 0 1-1.31 1.51l-.093-.08L12 13.425l-5.691 5.691a1 1 0 0 1-1.403-1.422L10.575 12l-5.67-5.67a1 1 0 0 1 1.31-1.51z"/></svg>
        </button>
      </div>

      <div class="p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto flex-1">
        <div class="lg:col-span-1 space-y-4">
          <div class="card p-4 md:p-5 bg-slate-800/40">
            <div class="text-sm text-slate-400" id="meta-time">â€”</div>
            <h5 class="text-xl md:text-2xl font-black text-white mt-1" id="meta-title">â€”</h5>
            <div class="mt-4 flex flex-wrap gap-2 text-xs" id="meta-chips"></div>
          </div>
          <div class="card p-4 md:p-5 flex flex-row lg:flex-col items-center justify-between lg:justify-center gap-4 bg-slate-800/40">
            <div class="text-sm font-semibold text-indigo-300">×¦×™×•×Ÿ ×××™× ×•×ª</div>
            <div class="text-4xl md:text-5xl font-black text-primary" id="score-box">â€”</div>
          </div>
        </div>
        
        <div class="lg:col-span-2 space-y-4 md:space-y-6">
          <div class="flex flex-wrap border-b border-slate-700/50 overflow-x-auto pb-1 gap-1">
            <button class="tab-btn active" data-tab="summary" onclick="switchTab('summary')">ğŸ“„ ×¡×™×›×•×</button>
            <button class="tab-btn" data-tab="faults" onclick="switchTab('faults')">ğŸ”§ ×ª×§×œ×•×ª</button>
            <button class="tab-btn" data-tab="costs" onclick="switchTab('costs')">ğŸ’° ×¢×œ×•×™×•×ª</button>
            <button class="tab-btn" data-tab="competitors" onclick="switchTab('competitors')">ğŸ†š ××ª×—×¨×™×</button>
            <button class="tab-btn" data-tab="sources" onclick="switchTab('sources')">ğŸ”— ××§×•×¨×•×ª</button>
          </div>
          
          <div id="tab-summary" class="prose prose-invert prose-sm md:prose-base max-w-none"></div>
          <div id="tab-faults" class="prose prose-invert prose-sm md:prose-base max-w-none" style="display:none"></div>
          <div id="tab-costs" class="prose prose-invert prose-sm md:prose-base max-w-none" style="display:none"></div>
          <div id="tab-competitors" class="prose prose-invert prose-sm md:prose-base max-w-none" style="display:none"></div>
          <div id="tab-sources" class="prose prose-invert prose-sm md:prose-base max-w-none" style="display:none"></div>
        </div>
      </div>

      <div class="px-4 py-4 md:px-6 border-t border-slate-700/50 flex items-center justify-end gap-3 shrink-0 bg-dark-lighter/80">
        <button onclick="closeModal()" class="px-5 py-2 rounded-xl text-slate-300 hover:text-white hover:bg-white/10 transition text-sm md:text-base">×¡×’×•×¨</button>
        <a href="/" class="btn px-6 py-2 rounded-xl text-white font-bold text-sm md:text-base">×‘×“×™×§×” ×—×“×©×”</a>
      </div>
    </div>
  </div>

  {% raw %}
  <script>
    // ×”××–× ×” ×œ×›×¤×ª×•×¨×™ "×”×¦×’ ×¤×¨×˜×™×"
    // ×× ×—× ×• ××©×ª××©×™× ×›××Ÿ ×‘-Delegate ×›×“×™ ×œ×•×•×“× ×©×–×” ×¢×•×‘×“ ×’× ×× ×”××œ×× ×˜×™× × ×˜×¢× ×™× ×“×™× ××™×ª
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.show-details');
      if (!btn) return;

      const id = btn.dataset.id;
      const mask = document.getElementById('modal-mask');
      const md = (t) => t ? marked.parse(String(t)) : '<p class="text-slate-400">â€”</p>';

      // ××™×¤×•×¡ ×•×”×¦×’×” ×¨××©×•× ×™×ª
      document.getElementById('tab-summary').innerHTML = '<div class="animate-pulse p-4 space-y-3"><div class="h-4 bg-slate-700 rounded w-3/4"></div><div class="h-4 bg-slate-700 rounded"></div></div>';
      
      // ××™×¤×•×¡ ×œ×˜××‘ ×”×¨××©×•×Ÿ
      switchTab('summary');
      
      // ×¤×ª×™×—×ª ××•×“×œ
      if (mask) {
        mask.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      try {
        const res = await fetch(`/search-details/${id}`);
        if (!res.ok) throw new Error('×©×’×™××” ×‘×©×œ×™×¤×ª ×¤×¨×˜×™×');
        const payload = await res.json();
        const meta = payload.meta || {};
        const data = payload.data || {};

        // ××˜× ×“××˜×”
        document.getElementById('meta-time').textContent = meta.timestamp || 'â€”';
        document.getElementById('meta-title').textContent =
          `${(meta.make||'').toUpperCase()} ${(meta.model||'').toUpperCase()} (${meta.year||'â€”'})`;

        const chips = [];
        if (meta.mileage_range) chips.push(`×§×´×: ${meta.mileage_range}`);
        if (meta.fuel_type)    chips.push(`×“×œ×§: ${meta.fuel_type}`);
        if (meta.transmission) chips.push(`×’×™×¨: ${meta.transmission}`);
        document.getElementById('meta-chips').innerHTML =
          chips.map(c => `<span class="chip px-3 py-1 rounded-full text-indigo-300 border border-indigo-500/20">${c}</span>`).join(' ');

        // ×¦×™×•×Ÿ
        let score = 0;
        if (typeof data.base_score_calculated !== 'undefined') {
          score = Number(data.base_score_calculated) || 0;
        }
        document.getElementById('score-box').textContent = (score > 0 ? Math.round(score) : 'â€”');

        // === ××™×œ×•×™ ×ª×•×›×Ÿ ×”×˜××‘×™× ===
        
        // 1. ×¡×™×›×•×
        const summary = data.reliability_summary || data.response || 'â€”';
        document.getElementById('tab-summary').innerHTML = md(summary);

        // 2. ×ª×§×œ×•×ª
        let faultsHtml = '';
        if (Array.isArray(data.common_issues) && data.common_issues.length) {
          faultsHtml += '<ul class="list-disc pr-5 space-y-2">';
          data.common_issues.forEach(i => faultsHtml += `<li>${i}</li>`);
          faultsHtml += '</ul>';
        }
        if (Array.isArray(data.issues_with_costs) && data.issues_with_costs.length) {
          faultsHtml += '<h4 class="text-xl font-bold mt-6 mb-3 text-white">×¢×œ×•×™×•×ª ×ª×™×§×•×Ÿ ××©×•×¢×¨×•×ª:</h4><ul class="space-y-3">';
          data.issues_with_costs.forEach(item => {
            const cost = (item && item.avg_cost_ILS != null) ? item.avg_cost_ILS : 'â€”';
            const issue = (item && item.issue) ? item.issue : 'â€”';
            faultsHtml += `<li class="bg-slate-700/30 p-3 rounded-lg flex justify-between items-center border border-slate-700/50"><span>${issue}</span><span class="font-bold text-primary">${cost} â‚ª</span></li>`;
          });
          faultsHtml += '</ul>';
        }
        document.getElementById('tab-faults').innerHTML = faultsHtml || '<p class="text-slate-400">××™×Ÿ ××™×“×¢ ×¢×œ ×ª×§×œ×•×ª.</p>';

        // 3. ×¢×œ×•×™×•×ª
        let costsHtml = '';
        if (data.avg_repair_cost_ILS) {
          costsHtml += `<h4 class="text-xl font-bold mb-3 text-white">×¢×œ×•×ª ×ª×—×–×•×§×” ×©× ×ª×™×ª ×××•×¦×¢×ª:</h4>
                        <p class="text-3xl font-black text-primary mb-6">${data.avg_repair_cost_ILS} â‚ª</p>`;
        }
        if (data.maintenance_cost_score) {
          costsHtml += `<p>×¦×™×•×Ÿ ×¢×œ×•×™×•×ª ××—×–×§×”: <strong>${data.maintenance_cost_score}/10</strong></p>`;
        }
        document.getElementById('tab-costs').innerHTML = costsHtml || '<p class="text-slate-400">××™×Ÿ ××™×“×¢ ×¢×œ ×¢×œ×•×™×•×ª.</p>';

        // 4. ××ª×—×¨×™×
        let compHtml = '';
        if (Array.isArray(data.common_competitors_brief) && data.common_competitors_brief.length) {
          compHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
          data.common_competitors_brief.forEach(c => {
            const m = (c && c.model) ? c.model : 'â€”';
            const b = (c && c.brief_summary) ? c.brief_summary : '';
            compHtml += `<div class="p-4 rounded-xl bg-slate-700/30 border border-slate-700/50">
                          <div class="font-bold text-white mb-1">${m}</div>
                          <div class="text-slate-300 text-sm">${b}</div>
                        </div>`;
          });
          compHtml += '</div>';
        }
        document.getElementById('tab-competitors').innerHTML = compHtml || '<p class="text-slate-400">××™×Ÿ ××™×“×¢ ×¢×œ ××ª×—×¨×™×.</p>';

        // 5. ××§×•×¨×•×ª
        let srcHtml = '';
        if (Array.isArray(data.sources) && data.sources.length) {
          srcHtml += '<ul class="list-disc pr-5 space-y-2">';
          data.sources.forEach(s => {
            const txt = String(s || '').trim();
            if (/^https?:\/\//i.test(txt)) {
              srcHtml += `<li><a class="text-primary underline underline-offset-4" href="${txt}" target="_blank" rel="noopener">×§×™×©×•×¨</a></li>`;
            } else {
              srcHtml += `<li>${txt}</li>`;
            }
          });
          srcHtml += '</ul>';
        }
        document.getElementById('tab-sources').innerHTML = srcHtml || '<p class="text-slate-400">××™×Ÿ ××§×•×¨×•×ª.</p>';

      } catch (err) {
        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×¨×˜×™×. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
        console.error(err);
      }
    });
  </script>
  {% endraw %}
</body>
</html>
